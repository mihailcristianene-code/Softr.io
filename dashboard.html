<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring Dashboard</title>

    <!-- React Libraries -->
    <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>

    <!-- Babel for JSX transpilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- XLSX-Populate for Excel Export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx-populate@1.21.0/browser/xlsx-populate.min.js"></script>

    <!-- Application Styles -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

        /* All styles are now scoped to the .monitoring-dashboard-container class */
        .monitoring-dashboard-container {
            font-family: 'Inter', sans-serif;
            background-color: #f0f0f0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            height: 100%;
        }

        .monitoring-dashboard-container {
            --bg-main: #f0f0f0;
            --bg-content: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-hover: #e2f0f9;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            --excel-green: #0D223F;
            --accent-blue: #0078d4;
            --accent-red: #d83b01;
            --row-selected-bg: #fff8e1;
            --error-bg-light: #ffebee;
        }

        .monitoring-dashboard-container .table-container::-webkit-scrollbar, .monitoring-dashboard-container .charts-container::-webkit-scrollbar { width: 8px; height: 8px; }
        .monitoring-dashboard-container .table-container::-webkit-scrollbar-thumb, .monitoring-dashboard-container .charts-container::-webkit-scrollbar-thumb { background-color: #ccc; border-radius: 4px; }
        .monitoring-dashboard-container .table-container::-webkit-scrollbar-track, .monitoring-dashboard-container .charts-container::-webkit-scrollbar-track { background-color: #f1f1f1; }

        .monitoring-dashboard-container .checkbox-group { display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; }
        .monitoring-dashboard-container .checkbox-label { display: flex; align-items: center; cursor: pointer; font-size: 0.875rem; font-weight: 500; color: var(--text-primary); }
        .monitoring-dashboard-container .checkbox-input { appearance: none; -webkit-appearance: none; width: 16px; height: 16px; border: 1px solid var(--border-color); border-radius: 4px; margin-right: 8px; position: relative; cursor: pointer; outline: none; transition: all 0.2s; }
        .monitoring-dashboard-container .checkbox-input:checked { background-color: var(--accent-blue); border-color: var(--accent-blue); }
        .monitoring-dashboard-container .checkbox-input:checked::before { content: 'âœ“'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 12px; }

        .monitoring-dashboard-container .loader-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: var(--text-secondary);
            font-size: 1.1rem;
            padding: 2rem;
            text-align: center;
        }
        .monitoring-dashboard-container .spinner {
            border: 5px solid rgba(0, 0, 0, 0.1);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border-left-color: var(--accent-blue);
            animation: monitoring-dashboard-spin 1s ease infinite;
            margin-bottom: 20px;
        }
        @keyframes monitoring-dashboard-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .monitoring-dashboard-container .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .monitoring-dashboard-container .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        .monitoring-dashboard-container .modal-content h2 {
            margin-top: 0;
            color: var(--excel-green);
        }
        .monitoring-dashboard-container .modal-content ul {
            list-style-type: disc;
            padding-left: 20px;
        }
        .monitoring-dashboard-container .modal-content li {
            margin-bottom: 10px;
        }
        .monitoring-dashboard-container .close-button {
            position: absolute;
            top: 15px;
            right: 15px;
            border: none;
            background: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: #888;
        }
        .monitoring-dashboard-container .action-button {
            background-color: var(--excel-green);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .monitoring-dashboard-container .action-button:hover {
            background-color: #1A4A8A;
        }
    </style>
</head>
<body>
    <!--
      This is the container for your Softr Custom Code block.
      The React application will be rendered inside this div.
    -->
    <div id="monitoring-dashboard-root">
        <div class="monitoring-dashboard-container">
            <div class="loader-container">
                <div class="spinner"></div>
                <p>Loading Application...</p>
            </div>
        </div>
    </div>

    <!-- Main application script -->
    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo, useRef } = React;

        // --- IMPORTANT ---
        // API calls have been removed for security.
        // Data must now be passed into the App component via props.
        // In Softr, you will need to use its Airtable integration to fetch
        // data and pass it to this custom code block.
        // Example of how data is expected: `window.airtableRecords`

        // --- Data Structure Constants ---
        const MONTHS_2025 = ["January 2025", "February 2025", "March 2025", "April 2025", "May 2025", "June 2025", "July 2025", "August 2025", "September 2025", "October 2025", "November 2025", "December 2025"];
        const MONTHS_2026 = ["January 2026", "February 2026", "March 2026", "April 2026", "May 2026", "June 2026", "July 2026", "August 2026", "September 2026", "October 2026", "November 2026", "December 2026"];
        const MONTHS_2027 = ["January 2027", "February 2027", "March 2027", "April 2027", "May 2027", "June 2027", "July 2027", "August 2027", "September 2027", "October 2027", "November 2027", "December 2027"];
        const MONTHS_2028 = ["January 2028", "February 2028", "March 2028", "April 2028", "May 2028", "June 2028", "July 2028", "August 2028", "September 2028", "October 2028", "November 2028", "December 2028"];
        const ALL_MONTHS = [...MONTHS_2025, ...MONTHS_2026, ...MONTHS_2027, ...MONTHS_2028];
        const BASE_FIELDS = ['Show Chart', 'Customer/ General meter', 'Meter serial number', 'Meter type', 'Location'];

        const analyzeData = (records, threshold, checkZeroError, useYearOverYear) => {
            if (!records || !Array.isArray(records)) {
                return [];
            }
            const deviationThreshold = threshold / 100;
            return records.map(record => {
                const errors = {};
                const calculatedConsumption = {};
                for (let i = 0; i < ALL_MONTHS.length; i++) {
                    const currentMonth = ALL_MONTHS[i];
                    const currentValue = record.fields[currentMonth];

                    if (i > 0) {
                        const previousMonth = ALL_MONTHS[i - 1];
                        const previousValue = record.fields[previousMonth];
                        if (typeof currentValue === 'number' && typeof previousValue === 'number' && !isNaN(currentValue) && !isNaN(previousValue)) {
                            const consumption = currentValue - previousValue;
                            calculatedConsumption[currentMonth] = consumption >= 0 ? consumption : 0;
                        } else {
                            calculatedConsumption[currentMonth] = null;
                        }
                    } else {
                         calculatedConsumption[currentMonth] = 0;
                    }

                    if (typeof currentValue !== 'number' || isNaN(currentValue)) {
                        continue;
                    }

                    let comparisonValue = null;

                    if (useYearOverYear) {
                        const [monthName, yearStr] = currentMonth.split(' ');
                        const year = parseInt(yearStr, 10);
                        const prevYearMonth = `${monthName} ${year - 1}`;
                        if (record.fields.hasOwnProperty(prevYearMonth) && typeof record.fields[prevYearMonth] === 'number') {
                            comparisonValue = record.fields[prevYearMonth];
                        }
                    }

                    if (comparisonValue === null && i > 0) {
                         const previousMonth = ALL_MONTHS[i - 1];
                         if (typeof record.fields[previousMonth] === 'number') {
                            comparisonValue = record.fields[previousMonth];
                         }
                    }

                    if (comparisonValue === null) {
                        continue;
                    }

                    if (comparisonValue !== 0) {
                        const deviation = Math.abs(currentValue - comparisonValue) / comparisonValue;
                        if (deviation > deviationThreshold) {
                            errors[currentMonth] = true;
                        }
                    } else if (checkZeroError && currentValue > 0) {
                        errors[currentMonth] = true;
                    }
                }
                return { ...record, errors, hasErrors: Object.keys(errors).length > 0, calculatedConsumption };
            });
        };

        const TableComponent = ({ data, handleSelectMeter, selectedMeter, displayedFields, checkedRows, handleCheckboxChange, handleSelectAllChange }) => {
            const stickyColumnCount = 2;

            const columnWidths = useMemo(() => {
                const widths = {};
                let cumulativeLeft = 0;
                const fieldWidths = {
                    'Show Chart': 60,
                    'Customer/ General meter': 220,
                    'Meter serial number': 150,
                    'Meter type': 150,
                    'Location': 150
                };

                displayedFields.forEach((field, index) => {
                    const isConsumption = typeof field === 'object';
                    const fieldName = isConsumption ? field.month : field;
                    const width = fieldWidths[fieldName] || (isConsumption ? 130 : 120);

                    widths[index] = {
                        width,
                        left: index < stickyColumnCount ? cumulativeLeft : undefined
                    };
                    if (index < stickyColumnCount) {
                        cumulativeLeft += width;
                    }
                });
                return widths;
            }, [displayedFields]);

            return (
                <div style={{ flex: '1', overflow: 'auto', backgroundColor: 'var(--bg-content)', boxShadow: '0 4px 12px rgba(0,0,0,0.05)', borderRadius: '12px', border: '1px solid var(--border-color)', minHeight: '300px',maxHeight: '500px' }} className="table-container">
                    <table style={{ borderCollapse: 'separate', borderSpacing: 0, fontFamily: "'Inter', sans-serif" }}>
                        <thead style={{ position: 'sticky', top: '0', zIndex: '2' }}>
                            <tr>
                                {displayedFields.map((field, index) => {
                                    const isConsumption = typeof field === 'object';
                                    const fieldName = isConsumption ? `${field.month.split(' ')[0]} Cons.` : field;
                                    const isSticky = index < stickyColumnCount;
                                    const { width, left } = columnWidths[index];

                                    const thStyle = {
                                        padding: '12px 16px',
                                        textAlign: 'center',
                                        whiteSpace: 'nowrap',
                                        width: `${width}px`,
                                        fontWeight: '600',
                                        border: '1px solid var(--border-color)',
                                        backgroundColor: isConsumption ? '#0a3d3d' : 'var(--excel-green)',
                                        color: 'white'
                                    };

                                    if (isSticky) {
                                        thStyle.position = 'sticky';
                                        thStyle.left = `${left}px`;
                                        thStyle.zIndex = 3;
                                        if (index === stickyColumnCount - 1) {
                                            thStyle.boxShadow = '3px 0px 5px -2px rgba(0,0,0,0.1)';
                                        }
                                    }

                                    if (fieldName === 'Show Chart') {
                                        return (
                                            <th key={index} style={thStyle}>
                                                <input
                                                    type="checkbox"
                                                    title="Select/Deselect All Visible"
                                                    style={{cursor: 'pointer', transform: 'scale(1.2)'}}
                                                    onChange={handleSelectAllChange}
                                                    checked={data.length > 0 && data.every(row => checkedRows.includes(row.id))}
                                                    ref={el => {
                                                        if (el) {
                                                            el.indeterminate = data.some(row => checkedRows.includes(row.id)) && !(data.length > 0 && data.every(row => checkedRows.includes(row.id)));
                                                        }
                                                    }}
                                                />
                                            </th>
                                        );
                                    }

                                    return <th key={index} style={thStyle}>{fieldName}</th>;
                                })}
                            </tr>
                        </thead>
                        <tbody>
                            {data.map((record, rowIndex) => (
                                <tr key={record.id} style={{ backgroundColor: selectedMeter?.id === record.id ? 'var(--row-selected-bg)' : 'transparent', transition: 'background-color 0.2s', cursor: 'pointer' }}
                                    onMouseEnter={(e) => e.currentTarget.style.backgroundColor = 'var(--bg-hover)'}
                                    onMouseLeave={(e) => e.currentTarget.style.backgroundColor = selectedMeter?.id === record.id ? 'var(--row-selected-bg)' : 'transparent'}
                                    onClick={() => handleSelectMeter(record)}>
                                    {displayedFields.map((field, cellIndex) => {
                                        const isConsumption = typeof field === 'object';
                                        const fieldName = isConsumption ? field.month : field;
                                        const isSticky = cellIndex < stickyColumnCount;
                                        const { left } = columnWidths[cellIndex];

                                        let baseBgColor;
                                        if (record.errors[fieldName]) {
                                            baseBgColor = 'var(--accent-red)';
                                        } else if (fieldName === 'Customer/ General meter' && record.hasErrors) {
                                            baseBgColor = 'var(--error-bg-light)';
                                        } else if (selectedMeter?.id === record.id) {
                                            baseBgColor = 'var(--row-selected-bg)';
                                        } else {
                                            baseBgColor = rowIndex % 2 === 0 ? 'var(--bg-content)' : 'var(--bg-secondary)';
                                        }

                                        const tdStyle = {
                                            padding: '12px 16px', textAlign: 'center', border: '1px solid var(--border-color)',
                                            backgroundColor: baseBgColor, color: record.errors[fieldName] ? 'white' : 'var(--text-primary)', whiteSpace: 'nowrap'
                                        };

                                        if (isSticky) {
                                            tdStyle.position = 'sticky';
                                            tdStyle.left = `${left}px`;
                                            tdStyle.zIndex = 1;
                                            if (cellIndex === stickyColumnCount - 1) {
                                                tdStyle.boxShadow = '3px 0px 5px -2px rgba(0,0,0,0.1)';
                                            }
                                        }

                                        if (fieldName === 'Show Chart') {
                                            return (
                                                <td key={cellIndex} style={tdStyle} onClick={(e) => e.stopPropagation()}>
                                                    <input type="checkbox" checked={checkedRows.includes(record.id)} onChange={() => handleCheckboxChange(record.id)} style={{cursor: 'pointer', transform: 'scale(1.2)'}}/>
                                                </td>
                                            );
                                        }

                                        let fieldValue;
                                        if(isConsumption) {
                                            fieldValue = record.calculatedConsumption[fieldName] ?? '-';
                                        } else {
                                            fieldValue = record.fields[fieldName] ?? '-';
                                        }

                                        return (
                                            <td key={cellIndex} style={tdStyle}>
                                                {fieldValue}
                                            </td>
                                        );
                                    })}
                                </tr>
                            ))}
                        </tbody>
                    </table>
                    {data.length === 0 && <div style={{ textAlign: 'center', padding: '2rem', color: 'var(--text-secondary)' }}>No meters found matching your criteria.</div>}
                </div>
            );
        };

        const SVGChart = ({ data, title, color }) => {
            const [tooltip, setTooltip] = useState(null);
            const containerRef = useRef(null);
            const width = 500, height = 140, margin = { top: 10, right: 40, bottom: 30, left: 40 };
            const innerWidth = width - margin.left - margin.right, innerHeight = height - margin.top - margin.bottom;

            const hasData = data.some(d => d.Consum !== null);

            if (!hasData) {
                 return (
                    <div style={{ backgroundColor: 'var(--bg-content)', padding: '16px', borderRadius: '12px', boxShadow: '0 4px 12px rgba(0,0,0,0.05)', border: '1px solid var(--border-color)'}}>
                        <h2 style={{ fontSize: '1rem', fontWeight: '600', marginBottom: '16px', textAlign: 'center', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>{title}</h2>
                        <div style={{ height: `${height}px`, display: 'flex', alignItems: 'center', justifyContent: 'center', color: 'var(--text-secondary)'}}>No data for this period.</div>
                    </div>
                );
            }

            const getScale = (domain, range) => (value) => range[0] + (value - domain[0]) * (range[1] - range[0]) / (domain[1] - domain[0]);
            const maxConsum = Math.max(0, ...data.map(d => d['Consum']).filter(v => v !== null));
            const generateTicks = (maxValue, tickCount = 4) => {
                if (maxValue === 0) return [0];
                const niceMaxValue = Math.ceil(maxValue / tickCount / 10) * 10 * tickCount;
                const step = niceMaxValue > 0 ? niceMaxValue / tickCount : 1;
                return Array.from({ length: tickCount + 1 }, (_, i) => Math.round(i * step));
            };
            const consumTicks = generateTicks(maxConsum);
            const xScale = getScale([0, data.length - 1], [0, innerWidth]);
            const yConsumScale = getScale([0, consumTicks[consumTicks.length-1] || 1], [innerHeight, 0]);

            const createSmoothPath = (points) => {
                if (points.length < 2) return '';
                let d = `M ${points[0][0]},${points[0][1]}`;
                for (let i = 0; i < points.length - 1; i++) {
                    const p0 = i > 0 ? points[i - 1] : points[i], p1 = points[i], p2 = points[i + 1], p3 = i < points.length - 2 ? points[i + 2] : p2;
                    const tension = 0.5;
                    const cp1x = p1[0] + (p2[0] - p0[0]) / 6 * tension, cp1y = p1[1] + (p2[1] - p0[1]) / 6 * tension;
                    const cp2x = p2[0] - (p3[0] - p1[0]) / 6 * tension, cp2y = p2[1] - (p3[1] - p1[1]) / 6 * tension;
                    d += ` C ${cp1x},${cp1y},${cp2x},${cp2y},${p2[0]},${p2[1]}`;
                }
                return d;
            };

            const consumPoints = data.map((d, i) => [xScale(i), yConsumScale(d['Consum'])]);
            const consumPath = createSmoothPath(consumPoints);
            const consumAreaPath = `${consumPath} L ${innerWidth},${innerHeight} L 0,${innerHeight} Z`;

            const handleMouseMove = (e) => {
                const rect = containerRef.current.getBoundingClientRect();
                const x = e.clientX - rect.left - margin.left;
                const index = Math.min(Math.max(Math.round(x / (innerWidth / (data.length - 1))), 0), data.length - 1);
                setTooltip({ data: data[index], x: xScale(index) });
            };

            return (
                <div style={{ backgroundColor: 'var(--bg-content)', padding: '16px', borderRadius: '12px', boxShadow: '0 4px 12px rgba(0,0,0,0.05)', border: '1px solid var(--border-color)'}}>
                    <h2 style={{ fontSize: '1rem', fontWeight: '600', margin: '0 0 10px 0', textAlign: 'center', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>{title}</h2>
                    <div style={{ position: 'relative' }}>
                        <svg ref={containerRef} viewBox={`0 0 ${width} ${height}`} onMouseMove={handleMouseMove} onMouseLeave={() => setTooltip(null)} style={{width: '100%', height: 'auto', fontFamily: "'Inter', sans-serif" }}>
                            <defs>
                                <linearGradient id={`gradient-${color.replace('#','')}`} x1="0" y1="0" x2="0" y2="1">
                                    <stop offset="0%" stopColor={color} stopOpacity={0.4}/><stop offset="100%" stopColor={color} stopOpacity={0}/>
                                </linearGradient>
                            </defs>
                            <g transform={`translate(${margin.left}, ${margin.top})`}>
                                {consumTicks.map(tick => (<line key={`grid-${tick}`} x1="0" x2={innerWidth} y1={yConsumScale(tick)} y2={yConsumScale(tick)} stroke="#e0e0e0" strokeDasharray="2 2" /> ))}
                                {consumTicks.map(tick => (<text key={`tick-consum-${tick}`} x={innerWidth + 8} y={yConsumScale(tick)} textAnchor="start" alignmentBaseline="middle" fontSize="10" fill="#666">{tick}</text>))}
                                {data.map((d, i) => (<text key={i} x={xScale(i)} y={innerHeight + 20} textAnchor="middle" fontSize="11" fill="#333">{d.name}</text>))}
                                <text transform={`rotate(90)`} y={-innerWidth - margin.right} x={innerHeight/2} textAnchor="middle" fontSize="11" fontWeight="500" fill={color}>Consumption</text>

                                <path d={consumAreaPath} fill={`url(#gradient-${color.replace('#','')})`} />
                                <path d={consumPath} fill="none" stroke={color} strokeWidth="3" />

                                {tooltip && (
                                    <g>
                                        <line x1={tooltip.x} y1="0" x2={tooltip.x} y2={innerHeight} stroke="#999" strokeDasharray="3 3"/>
                                        <circle cx={tooltip.x} cy={yConsumScale(tooltip.data['Consum'])} r="5" fill={color} stroke="white" strokeWidth="2"/>
                                    </g>
                                )}
                            </g>
                        </svg>
                        {tooltip && (
                           <div style={{ position: 'absolute', top: '0px', left: `${tooltip.x + margin.left + 5}px`, background: 'rgba(255, 255, 255, 0.95)', border: '1px solid #ccc', borderRadius: '4px', padding: '8px', fontSize: '12px', pointerEvents: 'none', boxShadow: '0 2px 5px rgba(0,0,0,0.1)', transform: tooltip.x > innerWidth / 2 ? 'translateX(-110%)' : 'none' }}>
                                <strong>{tooltip.data.name}</strong><br/>
                                <span style={{color: color}}>Consumption: {tooltip.data['Consum']}</span>
                           </div>
                        )}
                    </div>
                </div>
            )
        };

        // The App now accepts 'initialRecords' as a prop
        function App({ initialRecords }) {
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [filters, setFilters] = useState({ customer: '', serialNumber: '', meterType: '', location: '', year: ['2025'], month: '' });
            const [selectedMeter, setSelectedMeter] = useState(null);
            const [checkedRows, setCheckedRows] = useState([]);
            const [showHelpModal, setShowHelpModal] = useState(false);
            const [showAlarmModal, setShowAlarmModal] = useState(false);
            const [alarmThreshold, setAlarmThreshold] = useState(20);
            const [tempAlarmThreshold, setTempAlarmThreshold] = useState(20);
            const [checkZeroIndexError, setCheckZeroIndexError] = useState(true);
            const [tempCheckZeroIndexError, setTempCheckZeroIndexError] = useState(true);
            const [useYearOverYear, setUseYearOverYear] = useState(false);
            const [tempUseYearOverYear, setTempUseYearOverYear] = useState(false);
            const originalDataRef = useRef([]);

            const years = useMemo(() => Array.from(new Set(ALL_MONTHS.map(month => month.split(' ')[1]))).sort(), []);

            // Data is now processed from the prop, not fetched.
            useEffect(() => {
                if (initialRecords) {
                    setLoading(true);
                    originalDataRef.current = initialRecords;
                    const analyzedRecords = analyzeData(initialRecords, alarmThreshold, checkZeroIndexError, useYearOverYear);
                    setData(analyzedRecords);
                    setLoading(false);
                } else {
                    setError("Data not provided. Please configure data source in Softr.");
                    setLoading(false);
                }
            }, [initialRecords, alarmThreshold, checkZeroIndexError, useYearOverYear]);

            const handleSaveAlarmSettings = () => {
                const newThreshold = parseInt(tempAlarmThreshold, 10);
                if (!isNaN(newThreshold) && newThreshold > 0) {
                    setAlarmThreshold(newThreshold);
                    setCheckZeroIndexError(tempCheckZeroIndexError);
                    setUseYearOverYear(tempUseYearOverYear);
                    // Re-analyze data with new settings
                    const reAnalyzedData = analyzeData(originalDataRef.current, newThreshold, tempCheckZeroIndexError, tempUseYearOverYear);
                    setData(reAnalyzedData);
                    setShowAlarmModal(false);
                }
            };

            // handleUpdate function has been removed for security.
            // In-line editing must be handled by Softr's native features.

            const handleSelectMeter = (record) => setSelectedMeter(record);
            const handleCheckboxChange = (recordId) => {
                setCheckedRows(prev => prev.includes(recordId) ? prev.filter(id => id !== recordId) : [...prev, recordId]);
            };

            const filteredData = useMemo(() => data.filter(record =>
                (!filters.customer || record.fields['Customer/ General meter'] === filters.customer) &&
                (!filters.serialNumber || record.fields['Meter serial number'] === filters.serialNumber) &&
                (!filters.meterType || record.fields['Meter type'] === filters.meterType) &&
                (!filters.location || record.fields['Location'] === filters.location)
            ), [data, filters]);

            const filterOptions = useMemo(() => ({
                customers: [...new Set(data.map(r => r.fields['Customer/ General meter']).filter(Boolean))].sort(),
                serialNumbers: [...new Set(data.map(r => r.fields['Meter serial number']).filter(Boolean))].sort(),
                meterTypes: [...new Set(data.map(r => r.fields['Meter type']).filter(Boolean))].sort(),
                locations: [...new Set(data.map(r => r.fields['Location']).filter(Boolean))].sort(),
            }), [data]);

            const handleSelectAllChange = () => {
                const filteredIds = filteredData.map(r => r.id);
                const allVisibleChecked = filteredIds.length > 0 && filteredIds.every(id => checkedRows.includes(id));
                if (allVisibleChecked) {
                    setCheckedRows(prev => prev.filter(id => !filteredIds.includes(id)));
                } else {
                    setCheckedRows(prev => [...new Set([...prev, ...filteredIds])]);
                }
            };

            const getChartData = useCallback((months, meter) => {
                if (!meter) return [];
                return months.map(month => ({
                    name: month.split(' ')[0].substring(0, 3),
                    'Consum': meter.calculatedConsumption[month] ?? 0
                }));
            }, []);

            const displayedFields = useMemo(() => {
                let monthlyFieldsToShow = ALL_MONTHS.filter(month => filters.year.includes(month.split(' ')[1]));
                if(filters.month) {
                    monthlyFieldsToShow = [filters.month];
                }
                const interleavedFields = monthlyFieldsToShow.flatMap(month => [month, { type: 'consumption', month }]);
                return [...BASE_FIELDS, ...interleavedFields];
            }, [filters.year, filters.month]);

            const handleYearChange = (year) => {
                setFilters(prev => ({ ...prev, year: prev.year.includes(year) ? prev.year.filter(y => y !== year) : [...prev.year, year] }));
            };

            const handleFilterChange = (e, filterName) => {
                 setFilters(prev => ({ ...prev, [filterName]: e.target.value }));
            };

            const exportToExcel = async () => {
                if (typeof XlsxPopulate === 'undefined') {
                    alert("Export library is not available.");
                    return;
                }

                try {
                    const workbook = await XlsxPopulate.fromBlankAsync();
                    const sheet = workbook.sheet(0);

                    const headers = displayedFields
                        .map(field => (typeof field === 'object' ? `${field.month} Consumption` : field))
                        .filter(field => field !== 'Show Chart');

                    headers.forEach((header, index) => {
                        sheet.cell(1, index + 1).value(header).style({ bold: true, fill: "D9EAD3", horizontalAlignment: "center" });
                    });

                    filteredData.forEach((record, rowIndex) => {
                        let colIndex = 1;
                        displayedFields.forEach(field => {
                            if (field === 'Show Chart') return;

                            const value = typeof field === 'object'
                                ? record.calculatedConsumption[field.month] ?? ''
                                : record.fields[field] ?? '';

                            const cell = sheet.cell(rowIndex + 2, colIndex);
                            if (typeof value === 'number') {
                                cell.value(value);
                            } else {
                                cell.value(value);
                            }
                            colIndex++;
                        });
                    });

                    headers.forEach((_, index) => {
                        sheet.column(index + 1).width(20);
                    });

                    const blob = await workbook.outputAsync();
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement("a");
                    link.href = url;
                    link.download = "meter_data.xlsx";
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                } catch (err) {
                    console.error("Error exporting to XLSX:", err);
                    alert("Export failed.");
                }
            };

            const chartsToDisplay = checkedRows.flatMap(recordId => {
                const record = data.find(r => r.id === recordId);
                if (!record) return [];
                const meterName = `${record.fields['Customer/ General meter']} (${record.fields['Meter serial number']})`;
                const charts = [];
                if (filters.year.includes('2025')) {
                    charts.push(<SVGChart key={`${recordId}-2025`} title={`2025: ${meterName}`} data={getChartData(MONTHS_2025, record)} color="#82ca9d" />);
                }
                if (filters.year.includes('2026')) {
                    charts.push(<SVGChart key={`${recordId}-2026`} title={`2026: ${meterName}`} data={getChartData(MONTHS_2026, record)} color="#fe8082" />);
                }
                if (filters.year.includes('2027')) {
                    charts.push(<SVGChart key={`${recordId}-2027`} title={`2027: ${meterName}`} data={getChartData(MONTHS_2027, record)} color="#8884d8" />);
                }
                if (filters.year.includes('2028')) {
                    charts.push(<SVGChart key={`${recordId}-2028`} title={`2028: ${meterName}`} data={getChartData(MONTHS_2028, record)} color="#ffc658" />);
                }
                return charts;
            });

            if (loading) return (
                <div className="loader-container">
                    <div className="spinner"></div>
                    <p>Loading and processing data...</p>
                </div>
            );
            if (error) return <div style={{color: 'red', padding: '2rem', textAlign: 'center'}}>{error}</div>;

            return (
                <div className="monitoring-dashboard-container" style={{ height: '100%', display: 'flex', flexDirection: 'column', gap: '16px', padding: '16px', boxSizing: 'border-box' }}>
                    {showHelpModal && (
                        <div className="modal-overlay" onClick={() => setShowHelpModal(false)}>
                            <div className="modal-content" onClick={e => e.stopPropagation()}>
                                <button className="close-button" onClick={() => setShowHelpModal(false)}>&times;</button>
                                <h2>How to Use This Application</h2>
                                <ul>
                                    <li><strong>Filtering Data:</strong> Use the dropdowns and checkboxes to filter the table data.</li>
                                    <li><strong>Editing Data:</strong> Editing has been disabled in this view-only version. Data must be edited directly in Airtable or through a secure form in Softr.</li>
                                    <li><strong>Error Highlighting:</strong> Errors are highlighted in red based on the rules in 'Alarm Settings'.</li>
                                    <li><strong>Viewing Charts:</strong> Click the checkbox in the first column for any meter to display its annual consumption chart.</li>
                                    <li><strong>Exporting Data:</strong> Click "Export to Excel" to download the currently filtered data.</li>
                                </ul>
                            </div>
                        </div>
                    )}

                    {showAlarmModal && (
                         <div className="modal-overlay" onClick={() => setShowAlarmModal(false)}>
                            <div className="modal-content" onClick={e => e.stopPropagation()}>
                                <button className="close-button" onClick={() => setShowAlarmModal(false)}>&times;</button>
                                <h2>Alarm Settings</h2>
                                <div style={{marginTop: '20px'}}>
                                    <label style={{display: 'block', marginBottom: '10px', fontWeight: '500'}}>Deviation Threshold (%)</label>
                                    <input
                                        type="number"
                                        value={tempAlarmThreshold}
                                        onChange={(e) => setTempAlarmThreshold(e.target.value)}
                                        style={{width: '100px', padding: '8px', borderRadius: '4px', border: '1px solid #ccc'}}
                                    />
                                    <p style={{fontSize: '0.875rem', color: '#666', marginTop: '10px'}}>
                                        Flags an error if consumption deviates from the comparison month by more than this percentage.
                                    </p>
                                </div>
                                <div style={{marginTop: '20px', borderTop: '1px solid #eee', paddingTop: '20px'}}>
                                     <label className="checkbox-label" style={{justifyContent: 'flex-start'}}>
                                        <input type="checkbox" className="checkbox-input" checked={tempCheckZeroIndexError} onChange={(e) => setTempCheckZeroIndexError(e.target.checked)} />
                                        Flag error on index reset
                                    </label>
                                    <p style={{fontSize: '0.875rem', color: '#666', marginTop: '10px'}}>
                                        Flags an error when a meter's index goes from 0 to a positive value.
                                    </p>
                                </div>
                                <div style={{marginTop: '20px', borderTop: '1px solid #eee', paddingTop: '20px'}}>
                                     <label className="checkbox-label" style={{justifyContent: 'flex-start'}}>
                                        <input type="checkbox" className="checkbox-input" checked={tempUseYearOverYear} onChange={(e) => setTempUseYearOverYear(e.target.checked)} />
                                        Use year-over-year comparison
                                    </label>
                                    <p style={{fontSize: '0.875rem', color: '#666', marginTop: '10px'}}>
                                        Compares consumption to the same month of the previous year to handle seasonal fluctuations.
                                    </p>
                                </div>
                                <div style={{marginTop: '30px', display: 'flex', justifyContent: 'flex-end', gap: '10px'}}>
                                     <button onClick={() => setShowAlarmModal(false)} style={{padding: '8px 16px', borderRadius: '8px', border: '1px solid #ccc', background: '#f0f0f0', cursor: 'pointer'}}>Cancel</button>
                                     <button onClick={handleSaveAlarmSettings} className="action-button">Save</button>
                                </div>
                            </div>
                        </div>
                    )}


                    <div style={{ flexShrink: 0, backgroundColor: 'var(--bg-content)', borderRadius: '12px', border: '1px solid var(--border-color)', boxShadow: '0 4px 12px rgba(0,0,0,0.05)', padding: '16px', display: 'flex', flexDirection: 'column', gap: '16px' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', paddingBottom: '16px', borderBottom: '1px solid var(--border-color)' }}>
                            <div>
                                <h1 style={{ fontSize: '1.875rem', fontWeight: '800', color: 'var(--text-primary)', margin: 0 }}>Meter Monitoring Dashboard</h1>
                                <p style={{ color: 'var(--text-secondary)', fontSize: '0.875rem', marginTop: '4px', margin: 0 }}>View and manage consumption data.</p>
                            </div>
                            <div style={{display: 'flex', gap: '10px', alignItems: 'center'}}>
                                <button className="action-button" onClick={() => { setTempAlarmThreshold(alarmThreshold); setTempCheckZeroIndexError(checkZeroIndexError); setTempUseYearOverYear(useYearOverYear); setShowAlarmModal(true); }}>Alarm Settings</button>
                                <button className="action-button" onClick={() => setShowHelpModal(true)}>How to Use</button>
                                <button className="action-button" onClick={exportToExcel}>Export to Excel</button>
                            </div>
                        </div>
                        <div style={{ display: 'flex', alignItems: 'flex-end', gap: '16px', flexWrap: 'wrap' }}>
                            <div style={{ display: 'flex', flexDirection: 'column', flex: '1', minWidth: '180px' }}>
                                <label style={{ fontSize: '0.875rem', fontWeight: '500', color: 'var(--text-secondary)', marginBottom: '4px' }}>Customer / Meter</label>
                                <select value={filters.customer} onChange={(e) => handleFilterChange(e, 'customer')} style={{ padding: '8px 12px', border: '1px solid var(--border-color)', borderRadius: '8px', height: '39px' }}>
                                    <option value="">All Customers</option>
                                    {filterOptions.customers.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                </select>
                            </div>
                            <div style={{ display: 'flex', flexDirection: 'column', flex: '1', minWidth: '180px' }}>
                                <label style={{ fontSize: '0.875rem', fontWeight: '500', color: 'var(--text-secondary)', marginBottom: '4px' }}>Serial Number</label>
                                <select value={filters.serialNumber} onChange={(e) => handleFilterChange(e, 'serialNumber')} style={{ padding: '8px 12px', border: '1px solid var(--border-color)', borderRadius: '8px', height: '39px' }}>
                                    <option value="">All Serials</option>
                                    {filterOptions.serialNumbers.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                </select>
                            </div>
                             <div style={{ display: 'flex', flexDirection: 'column', flex: '1', minWidth: '180px' }}>
                                <label style={{ fontSize: '0.875rem', fontWeight: '500', color: 'var(--text-secondary)', marginBottom: '4px' }}>Meter Type</label>
                                <select value={filters.meterType} onChange={(e) => handleFilterChange(e, 'meterType')} style={{ padding: '8px 12px', border: '1px solid var(--border-color)', borderRadius: '8px', height: '39px' }}>
                                     <option value="">All Types</option>
                                    {filterOptions.meterTypes.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                </select>
                            </div>
                             <div style={{ display: 'flex', flexDirection: 'column', flex: '1', minWidth: '180px' }}>
                                <label style={{ fontSize: '0.875rem', fontWeight: '500', color: 'var(--text-secondary)', marginBottom: '4px' }}>Location</label>
                                <select value={filters.location} onChange={(e) => handleFilterChange(e, 'location')} style={{ padding: '8px 12px', border: '1px solid var(--border-color)', borderRadius: '8px', height: '39px' }}>
                                    <option value="">All Locations</option>
                                    {filterOptions.locations.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                </select>
                            </div>
                            <div style={{ display: 'flex', flexDirection: 'column', flex: '1', minWidth: '180px' }}>
                                <label style={{ fontSize: '0.875rem', fontWeight: '500', color: 'var(--text-secondary)', marginBottom: '4px' }}>Month</label>
                                <select value={filters.month} onChange={(e) => handleFilterChange(e, 'month')} style={{ padding: '8px 12px', border: '1px solid var(--border-color)', borderRadius: '8px', height: '39px' }}>
                                    <option value="">All Months</option>
                                    {ALL_MONTHS.map(m => <option key={m} value={m}>{m}</option>)}
                                </select>
                            </div>
                            <div style={{ display: 'flex', flexDirection: 'column' }}>
                                <label style={{ fontSize: '0.875rem', fontWeight: '500', color: 'var(--text-secondary)', marginBottom: '4px' }}>Year</label>
                                <div className="checkbox-group" style={{ height: '39px', boxSizing: 'border-box' }}>
                                    {years.map(year => (
                                        <label key={year} className="checkbox-label">
                                            <input type="checkbox" className="checkbox-input" checked={filters.year.includes(year)} onChange={() => handleYearChange(year)} />
                                            {year}
                                        </label>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>

                    {chartsToDisplay.length > 0 && (
                        <div className="charts-container" style={{flexShrink: 0, maxHeight: '280px', overflowY: 'auto', padding: '10px 10px 10px 0' }}>
                             <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(400px, 1fr))', gap: '16px'}}>
                                {chartsToDisplay}
                                {chartsToDisplay.length % 2 !== 0 && <div />}
                            </div>
                        </div>
                    )}

                    <TableComponent data={filteredData} handleSelectMeter={handleSelectMeter} selectedMeter={selectedMeter} displayedFields={displayedFields} checkedRows={checkedRows} handleCheckboxChange={handleCheckboxChange} handleSelectAllChange={handleSelectAllChange} />
                </div>
            );
        }

        // --- Softr Integration ---
        // This function will be called by Softr to initialize the application.
        // It expects the Airtable records to be available on the window object.
        function initializeDashboard(records) {
             ReactDOM.render(
                <App initialRecords={records} />,
                document.getElementById('monitoring-dashboard-root')
            );
        }

        // Example of how to pass data from Softr.
        // In your Softr Custom Code block, you will need to make sure `window.airtableRecords`
        // is populated with your data before this script runs.
        // For example:
        // <script>
        //   window.airtableRecords = {records}; // '{records}' is a placeholder for Softr's data variable
        // </script>
        //
        // Then, you can call initializeDashboard(window.airtableRecords)

        // For testing purposes, you can uncomment the line below and replace with sample data.
        // initializeDashboard([{ id: 'rec1', fields: { 'Customer/ General meter': 'Test' } }]);

    </script>
</body>
</html>